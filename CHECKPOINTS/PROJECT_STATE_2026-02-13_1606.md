# PROJECT_STATE

## Goal
- Deliver RelayDocs as a production-style collaborative document platform with deterministic behavior, strict typing, validated API boundaries, and server-enforced authorization.

## Non-Goals
- Sweeping refactors without request.
- Relaxing strict TypeScript, RBAC, or validation rules.
- Storing secrets in code/logs.

## Current Architecture
- Frontend: `apps/web` (React + TypeScript + Vite + Tailwind + React Router + TanStack Query).
- API Gateway: `apps/gateway` (Node.js + TypeScript + Zod validation + auth middleware; currently supports dev-token and JWT verification).
- Document microservice: `services/document-service` (Spring Boot MVC + JPA/Hibernate + Bean Validation + Flyway).
- Data: PostgreSQL 16, schema managed by Flyway migrations (`V1__init.sql`, `V2__consumed_events.sql`).
- Events: Redpanda (Kafka-compatible), idempotent consumer dedupe using `consumed_events`.

## Data Model
- `users`: document principals.
- `documents`: owner, title/content, timestamps.
- `document_permissions`: per-user document role (`viewer`/`editor`).
- `consumed_events`: idempotent event-consumption tracking.
- Planned auth extension: username/password credential storage linked to user principals.

## Key Commands
- Install deps: `npm install`
- Full stack up: `docker compose up --build -d`
- Full stack down: `docker compose down`
- Reset volumes: `docker compose down -v && docker compose up --build -d`
- Live-edit prep: `docker compose stop web gateway && docker compose up -d postgres redpanda document-service`
- Local gateway: `npm run dev:gateway` (8082)
- Local web: `npm run dev:web` (5174)
- Web tests: `npm run -w web test`
- Workspace tests: `npm test`

## Files Created/Modified And Why (Recent)
- `apps/web/src/auth/session.ts`, `apps/web/src/App.tsx`, `apps/web/src/api/documents.ts`: in-app session login/logout and token-backed API calls for UI-based RBAC testing.
- `apps/web/src/App.tsx`: inline share-role switching in Current Access and user-friendly forbidden messages.
- `services/document-service/src/test/java/com/relaydocs/documentservice/service/DocumentServiceTest.java`: RBAC and sequential concurrent update tests.
- `.github/workflows/ci.yml`: concurrency cancellation, timeout caps, Playwright cache.

## Completed
- UI-based manual validation for core flow and RBAC/concurrency behavior is now feasible.
- Share-role mutation from Current Access is implemented.
- Friendly forbidden error messaging is implemented in web UI.
- Web test suite passing locally (`apps/web`).

## Open Tasks (Prioritized)
1. Implement real username/password auth (Sign Up + Login) backed by database.
2. Integrate frontend auth page with explicit Sign Up/Login actions using backend endpoints.
3. Validate CI in GitHub first PR run and tune if required.
4. Add Kafka broker-backed integration tests.
5. Add compose operational notes for Docker snapshot/cache recovery.

## Known Issues / Edge Cases
- Docker Desktop must be running before compose commands; otherwise named-pipe connection errors occur.
- Live-edit mode and full compose mode can conflict on ports if `web`/`gateway` compose services are not stopped.
- Existing DB volumes created pre-Flyway may require `docker compose down -v` before migration-managed startup.

## Next 3 Actions
- [ ] Implement DB-backed username/password auth endpoints (`signup`, `login`) and JWT issuance.
- [ ] Wire web app to first-screen Sign Up/Login flow and persist JWT session.
- [ ] Re-run targeted tests and manual auth + RBAC UI checks.
