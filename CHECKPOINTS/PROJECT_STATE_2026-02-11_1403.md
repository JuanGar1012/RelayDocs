# PROJECT_STATE

## Goal
- Deliver a production-style collaborative document management platform (RelayDocs) with deterministic behavior, strict typing, validated API boundaries, server-enforced authorization, and interview-ready engineering quality.

## Non-Goals
- Large refactors not explicitly requested.
- Relaxing strict typing, RBAC, or validation guarantees.
- Adding secrets to source code or logs.

## Current Architecture
- Frontend: `apps/web` (React + TypeScript + Vite + Tailwind, Router, TanStack Query).
- API Gateway: `apps/gateway` (Node.js + TypeScript + Zod, JWT/dev-token auth, REST aggregation/proxy).
- Microservice: `services/document-service` (Spring Boot MVC + JPA/Hibernate + Bean Validation).
- Database: PostgreSQL with Flyway migrations in `services/document-service/src/main/resources/db/migration`.
- Events: Kafka-compatible broker (Redpanda via Docker), domain events emitted for document and permission changes.
- Container orchestration: full-stack `docker-compose` for postgres, redpanda, document-service, gateway, and web.

## Data Model (Current/Planned Core)
- `users`
- `documents` (owner, title, content/body, timestamps)
- sharing/RBAC join structure for per-document permissions (viewer/editor semantics)
- event payloads for `document.created`, `document.updated`, `document.shared`, `permission.changed`

## Key Commands
- Install deps: `npm install`
- Full stack up: `docker compose up --build -d`
- Full stack down: `docker compose down`
- Frontend dev: `npm run dev:web`
- Gateway dev: `npm run dev:gateway`
- Workspace build: `npm run build`
- Workspace test: `npm test`
- E2E tests: `npm run test:e2e`
- Workspace lint: `npm run lint`
- Spring service dev: `cd services/document-service && mvn spring-boot:run`

## Files Created/Modified (Since Last Checkpoint)
- `docker-compose.yml`: full-stack service orchestration.
- `services/document-service/Dockerfile`: containerized Spring Boot build/run.
- `apps/gateway/Dockerfile`: containerized gateway build/run.
- `apps/web/Dockerfile`, `apps/web/nginx.conf`: containerized web build with SPA/API proxy behavior.
- `services/document-service/pom.xml`: Flyway dependency.
- `services/document-service/src/main/resources/application.yml`: `ddl-auto=validate`, Flyway enabled.
- `services/document-service/src/main/resources/db/migration/V1__init.sql`: versioned initial schema.
- `services/document-service/src/test/resources/application-test.yml`: Flyway disabled in tests.
- `apps/gateway/src/client/documentServiceClient.test.ts`: downstream contract tests.
- `e2e/playwright.config.ts`, `e2e/tests/smoke.spec.ts`: initial Playwright smoke test.
- `package.json`, `package-lock.json`: Playwright dependency and `test:e2e` script.
- `README.md`: full-stack startup, migration, and e2e docs.

## Completed
- Monorepo scaffold established (`apps/*`, `services/*`, `infra/*`).
- Gateway boundary validation hardened (numeric document ids, stricter request mapping).
- RBAC hardening implemented (permission role constraints, owner self-share guard).
- Deterministic schema migration path implemented via Flyway.
- Full-stack compose orchestration implemented for manual app testing.
- Gateway, web, and Spring test suites passing after integration changes.

## Open Tasks (Prioritized)
1. Run and verify the new compose flow on a host with Docker and check end-to-end browser behavior.
2. Install Playwright browsers and execute `npm run test:e2e` against running full stack.
3. Implement Kafka consume-side idempotency and reliability tests.
4. Expand negative-path E2E coverage (forbidden edits, invalid share, malformed ids).
5. Add CI workflows for lint/test/build/e2e gates.

## Known Issues / Edge Cases
- Docker CLI is not available in this execution environment, so compose runtime verification could not be executed here.
- Existing persistent local databases created before Flyway may require `docker compose down -v` before first migration-managed startup.
- Kafka idempotent consumer behavior is not implemented yet.
- RBAC race/edge cases still need dedicated tests.

## Next 3 Actions
- [ ] Start full stack with compose on host machine and run manual smoke checks in browser.
- [ ] Install Playwright browsers and execute `npm run test:e2e`.
- [ ] Implement Kafka idempotency strategy and tests for repeated permission/document events.
