# PROJECT_STATE

## Goal
- Deliver RelayDocs as a production-style collaborative document platform with deterministic behavior, strict typing, validated API boundaries, and server-enforced authorization.

## Non-Goals
- Sweeping refactors without request.
- Relaxing strict TypeScript, RBAC, or validation rules.
- Storing secrets in code/logs.

## Current Architecture
- Frontend: `apps/web` (React + TypeScript + Vite + Tailwind + React Router + TanStack Query).
- API Gateway: `apps/gateway` (Node.js + TypeScript + Zod validation + token auth).
- Document microservice: `services/document-service` (Spring Boot MVC + JPA/Hibernate + Bean Validation + Flyway).
- Data: PostgreSQL 16, schema managed by Flyway migration `V1__init.sql`.
- Events: Redpanda (Kafka-compatible) provisioned in compose; publish-side wiring exists.
- Runtime paths:
  - Containerized full stack: `docker-compose.yml` orchestrates `postgres`, `redpanda`, `document-service`, `gateway`, and `web`.
  - Live-edit stack: Docker infra (`postgres`, `redpanda`, `document-service`) + local watch servers (`gateway`, `web`) for deterministic HMR iteration.

## Data Model
- `users` table for principals.
- `documents` table for owned content (`title`, `content`, timestamps, owner id).
- `document_permissions` join model for per-user access (`viewer`/`editor`) with owner guards.
- Domain event types: `document.created`, `document.updated`, `document.shared`, `permission.changed`.

## Key Commands
- Install JS deps: `npm install`
- First-time env setup:
  - `Copy-Item .env.example .env`
  - `Copy-Item apps/gateway/.env.example apps/gateway/.env`
  - `Copy-Item apps/web/.env.example apps/web/.env`
- Start full stack (containerized): `docker compose up --build -d`
- Stop full stack: `docker compose down`
- Reset stack volumes: `docker compose down -v && docker compose up --build -d`
- Live edit prep: `docker compose stop web gateway && docker compose up -d postgres redpanda document-service`
- Gateway dev mode (local): `npm run dev:gateway` (port `8082`)
- Web dev mode (local): `npm run dev:web` (port `5174`)
- Spring dev mode: `cd services/document-service && mvn spring-boot:run`
- Workspace tests: `npm test`
- E2E tests: `npm run test:e2e`
- Lint: `npm run lint`

## Files Created/Modified And Why
- `services/document-service/pom.xml`: added Flyway PostgreSQL module to support Postgres 16.x migrations at runtime.
- `apps/web/nginx.conf`: added SPA static `root`/`index` directives to stop Nginx internal redirect cycle on route refreshes.
- `e2e/playwright.config.ts`, `e2e/tests/smoke.spec.ts`: smoke coverage for create/open flow.
- `apps/web/src/index.css`, `apps/web/src/App.tsx`: introduced blue-gradient UI system, animated hover buttons, and document-list empty state.
- `apps/gateway/src/index.ts`: production-safe explicit server startup, env-driven port parsing, and deterministic `EADDRINUSE` handling.
- `apps/gateway/.env.example`, `apps/web/.env.example`, `.env.example`: standardized environment templates for local and compose workflows.
- `docker-compose.yml`: parameterized via root `.env` with safe defaults for ports, DB credentials, and runtime toggles.
- `README.md`: reconciled and documented stable full-stack and live-edit workflows.

## Completed
- Compose stack fully validated on Docker host.
- All five services running together: web, gateway, document-service, postgres, redpanda.
- Flyway migration path verified end-to-end against PostgreSQL 16 (`V1` applied).
- Web routing runtime issue fixed (`/documents` no longer serves 500 from Nginx loop).
- Playwright browsers installed locally.
- E2E smoke test passes (`npm run test:e2e`).
- Local live-edit workflow stabilized with dedicated no-collision ports (`8082` gateway, `5174` web).
- `.env`-driven config integrated across gateway/web and compose.
- Empty-state UX added for zero-document list.

## Open Tasks (Prioritized)
1. Implement Kafka consumer idempotency/replay protection and add reliability tests.
2. Add negative-path E2E tests (forbidden edit/share, malformed ids, auth failures).
3. Add CI workflow gates for lint/test/build/e2e.
4. Expand service-level tests around RBAC edge cases and concurrent updates.
5. Continue UI polish pass (animation tuning, accessibility pass, consistency of components across pages).

## Known Issues / Edge Cases
- Existing pre-Flyway local DB volumes may require `docker compose down -v` before first migration-managed boot.
- Consumer-side idempotency for domain events is not implemented yet.
- E2E currently validates only the happy path (single smoke flow).
- Live-edit flow intentionally runs on `8082/5174`; full containerized flow remains on `8080/5173`. Mixing modes without stopping `web/gateway` compose services can reintroduce port conflicts.

## Next 3 Actions
- [ ] Implement idempotent Kafka consumer strategy (dedupe key/store + retry semantics).
- [ ] Add at least 3 negative E2E scenarios for permissions and invalid ids.
- [ ] Wire CI jobs to enforce lint + unit/integration + E2E on PRs.
