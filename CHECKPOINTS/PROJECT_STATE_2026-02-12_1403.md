# PROJECT_STATE

## Goal
- Deliver RelayDocs as a production-style collaborative document platform with deterministic behavior, strict typing, validated API boundaries, and server-enforced authorization.

## Non-Goals
- Sweeping refactors without request.
- Relaxing strict TypeScript, RBAC, or validation rules.
- Storing secrets in code/logs.

## Current Architecture
- Frontend: `apps/web` (React + TypeScript + Vite + Tailwind + React Router + TanStack Query).
- API Gateway: `apps/gateway` (Node.js + TypeScript + Zod validation + token auth).
- Document microservice: `services/document-service` (Spring Boot MVC + JPA/Hibernate + Bean Validation + Flyway).
- Data: PostgreSQL 16, schema managed by Flyway migrations `V1__init.sql` and `V2__consumed_events.sql`.
- Events: Redpanda (Kafka-compatible) with publish and consume paths in document-service.
- Consumer idempotency: DB-backed dedupe (`consumed_events` unique key on `consumer_name + event_id`) and fallback hash when incoming `eventId` is missing.
- Runtime paths:
  - Containerized full stack: `docker-compose.yml` orchestrates `postgres`, `redpanda`, `document-service`, `gateway`, and `web`.
  - Live-edit stack: Docker infra (`postgres`, `redpanda`, `document-service`) + local watch servers (`gateway`, `web`) for deterministic HMR iteration.

## Data Model
- `users` table for principals.
- `documents` table for owned content (`title`, `content`, timestamps, owner id).
- `document_permissions` join model for per-user access (`viewer`/`editor`) with owner guards.
- `consumed_events` table for Kafka consumer dedupe and replay protection.
- Domain event types: `document.created`, `document.updated`, `document.shared`, `permission.changed`.

## Key Commands
- Install JS deps: `npm install`
- First-time env setup:
  - `Copy-Item .env.example .env`
  - `Copy-Item apps/gateway/.env.example apps/gateway/.env`
  - `Copy-Item apps/web/.env.example apps/web/.env`
- Start full stack (containerized): `docker compose up --build -d`
- Stop full stack: `docker compose down`
- Reset stack volumes: `docker compose down -v && docker compose up --build -d`
- Live edit prep: `docker compose stop web gateway && docker compose up -d postgres redpanda document-service`
- Gateway dev mode (local): `npm run dev:gateway` (port `8082`)
- Web dev mode (local): `npm run dev:web` (port `5174`)
- Spring dev mode: `cd services/document-service && mvn spring-boot:run`
- Workspace tests: `npm test`
- E2E tests: `npm run test:e2e`
- Lint: `npm run lint`

## Files Created/Modified And Why
- `services/document-service/pom.xml`: added Flyway PostgreSQL module to support Postgres 16.x migrations at runtime.
- `apps/web/nginx.conf`: added SPA static `root`/`index` directives to stop Nginx internal redirect cycle on route refreshes.
- `e2e/playwright.config.ts`, `e2e/tests/smoke.spec.ts`: smoke coverage for create/open flow; smoke now waits on create response for deterministic assertion timing.
- `e2e/tests/negative.spec.ts`: negative E2E coverage for forbidden edit, malformed id, and owner self-share.
- `apps/web/src/index.css`, `apps/web/src/App.tsx`: introduced blue-gradient UI system, animated hover buttons, and document-list empty state.
- `apps/gateway/src/index.ts`: production-safe explicit server startup, env-driven port parsing, and deterministic `EADDRINUSE` handling.
- `apps/gateway/.env.example`, `apps/web/.env.example`, `.env.example`: standardized environment templates for local and compose workflows.
- `docker-compose.yml`: parameterized via root `.env` with safe defaults for ports, DB credentials, and runtime toggles; explicitly pins gateway container runtime to `PORT=8080`.
- `README.md`: reconciled and documented stable full-stack and live-edit workflows.
- `services/document-service/src/main/java/com/relaydocs/documentservice/events/*`: added idempotent Kafka consumer pipeline (`KafkaDomainEventConsumer`, `ConsumedEventRecorder`, repository/entity, retry config, property extensions).
- `.github/workflows/ci.yml`: CI gates for lint/test/build, Spring tests, and Playwright E2E with compose stack boot.

## Completed
- Compose stack fully validated on Docker host.
- All five services running together: web, gateway, document-service, postgres, redpanda.
- Flyway migration path verified end-to-end against PostgreSQL 16 (`V1` applied).
- Web routing runtime issue fixed (`/documents` no longer serves 500 from Nginx loop).
- Playwright browsers installed locally.
- E2E suite passes (`npm run test:e2e`) including smoke and 3 negative scenarios.
- Local live-edit workflow stabilized with dedicated no-collision ports (`8082` gateway, `5174` web).
- `.env`-driven config integrated across gateway/web and compose.
- Empty-state UX added for zero-document list.
- Kafka consumer idempotency/replay protection implemented with tests in document-service.
- CI workflow gates implemented in GitHub Actions (`.github/workflows/ci.yml`).

## Open Tasks (Prioritized)
1. Expand service-level tests around RBAC edge cases and concurrent updates.
2. Continue UI polish pass (animation tuning, accessibility pass, component consistency, focus/contrast accessibility).
3. Validate CI in GitHub (first PR run), then tune runtime and caching if needed.
4. Add Kafka integration tests with broker-backed consumer execution (beyond unit/service tests).
5. Add operational notes for compose build cache/snapshot recovery on local Docker issues.

## Known Issues / Edge Cases
- Existing pre-Flyway local DB volumes may require `docker compose down -v` before first migration-managed boot.
- Live-edit flow intentionally runs on `8082/5174`; full containerized flow remains on `8080/5173`. Mixing modes without stopping `web/gateway` compose services can reintroduce port conflicts.
- `docker compose up --build` can intermittently hit local Docker snapshot extraction errors; plain `docker compose up -d` with existing images remains a current workaround.

## Next 3 Actions
- [ ] Add RBAC edge-case and concurrency-focused service tests.
- [ ] Refine UI polish with accessibility-focused adjustments and interaction tuning.
- [ ] Confirm first CI run on GitHub and adjust workflow performance/stability if required.
