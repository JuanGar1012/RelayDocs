# PROJECT_STATE

## Goal
- Deliver RelayDocs as a production-style collaborative document platform with deterministic behavior, strict typing, validated API boundaries, and server-enforced authorization.

## Non-Goals
- Sweeping refactors without request.
- Relaxing strict TypeScript, RBAC, or validation rules.
- Storing secrets in code/logs.

## Current Architecture
- Frontend: `apps/web` (React + TypeScript + Vite + Tailwind + React Router + TanStack Query).
- API Gateway: `apps/gateway` (Node.js + TypeScript + Zod validation + auth middleware + JWT issuance).
- Document microservice: `services/document-service` (Spring Boot MVC + JPA/Hibernate + Bean Validation + Flyway).
- Data: PostgreSQL 16 with Flyway migrations (`V1__init.sql`, `V2__consumed_events.sql`, `V3__auth_credentials.sql`).
- Events: Redpanda (Kafka-compatible), idempotent consumer dedupe through `consumed_events`.

## Data Model
- `users`: principal records used by document ownership and RBAC.
- `auth_credentials`: username (`user_id`) + `password_hash` for login.
- `documents`: owner, title/content, timestamps.
- `document_permissions`: per-user `viewer`/`editor` roles.
- `consumed_events`: event replay/idempotency tracking.

## Key Commands
- Install deps: `npm install`
- Full stack up: `docker compose up --build -d`
- Full stack down: `docker compose down`
- Reset volumes: `docker compose down -v --remove-orphans`
- Live-edit infra: `docker compose stop web gateway && docker compose up -d postgres redpanda document-service`
- Gateway local: `npm run dev:gateway` (8082)
- Web local: `npm run dev:web` (5174)
- Web tests: `npm run -w web test`
- Gateway tests: `npm run -w gateway test`
- Service tests: `mvn -B -f services/document-service/pom.xml test`

## Files Created/Modified And Why (High Level)
- `apps/web/src/App.tsx`, `apps/web/src/api/auth.ts`, `apps/web/src/auth/session.ts`, `apps/web/src/api/documents.ts`: added first-screen Sign Up/Login UX, persisted session JWT usage, and retained RBAC UX improvements (inline role switching, friendly forbidden messages).
- `apps/gateway/src/routes/auth.ts`, `apps/gateway/src/schemas/auth.ts`, `apps/gateway/src/app.ts`, `apps/gateway/src/client/documentServiceClient.ts`: added `/api/v1/auth/signup|login`, request validation, JWT issuance, and downstream auth forwarding.
- `services/document-service/src/main/java/com/relaydocs/documentservice/api/AuthController.java`, `services/document-service/src/main/java/com/relaydocs/documentservice/service/AuthService.java`, `services/document-service/src/main/java/com/relaydocs/documentservice/persistence/AuthCredential*`, `services/document-service/src/main/resources/db/migration/V3__auth_credentials.sql`: implemented DB-backed username/password auth with bcrypt and credential persistence.
- `services/document-service/src/main/java/com/relaydocs/documentservice/api/ApiExceptionHandler.java`, `services/document-service/src/main/java/com/relaydocs/documentservice/service/ApiUnauthorizedException.java`: added unauthorized response handling.
- `services/document-service/pom.xml`: added `spring-security-crypto` for bcrypt.
- `apps/web/.env.example`: removed dev token default from canonical setup.

## Completed
- In-app login/logout session flow implemented.
- Username/password Sign Up + Login implemented end-to-end (web -> gateway -> document-service).
- JWT issuance integrated in gateway and consumed by existing protected document routes.
- Existing RBAC and concurrency testing workflows preserved and improved via UI.
- Share role can now be changed inline in `Current Access`.
- Forbidden messages are user-friendly in the UI.
- Tests passing locally:
  - `npm run -w gateway test`
  - `npm run -w web test`
  - `mvn -B -f services/document-service/pom.xml test`

## Open Tasks (Prioritized)
1. Manually validate signup/login flow in browser and re-run RBAC + concurrency scenarios with real authenticated users.
2. Confirm first GitHub CI run for these auth changes and tune workflow/runtime if needed.
3. Add Kafka broker-backed integration tests for consumer execution.
4. Add operational notes for Docker snapshot/cache recovery issues.

## Known Issues / Edge Cases
- Docker Desktop must be running; otherwise compose fails with named-pipe connection errors.
- Switching between full-compose and live-edit modes requires stopping compose `web/gateway` to avoid port conflicts.
- Older local volumes may need `docker compose down -v` so Flyway applies latest migrations cleanly.

## Next 3 Actions
- [ ] Run manual browser validation for Sign Up/Login + RBAC + concurrency.
- [ ] Validate first GitHub CI run and adjust workflow if required.
- [ ] Implement Kafka broker-backed integration tests.
